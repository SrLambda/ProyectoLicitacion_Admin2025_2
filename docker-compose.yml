#version docker-compose
version: '3.8'

services:
  #router
  gateway:
    image: traefik:v2.10  
    container_name: gateway    
    command:
      - "--api.insecure=true"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--entrypoints.web.address=:80"
    ports:
      - "8081:80"
      - "8080:8080"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - app-network
    restart: unless-stopped

  db-master:
    build:
      context: ./db
    container_name: db-master
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-root}
      MYSQL_DATABASE: ${MYSQL_DATABASE:-appdb}
      MYSQL_USER: ${MYSQL_USER:-appuser}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD:-password}
    command:
      - --server-id=1
      - --log-bin=mysql-bin
      - --binlog-do-db=${MYSQL_DATABASE:-appdb}
      - --gtid-mode=ON
      - --enforce-gtid-consistency=ON
      - --ssl-ca=/etc/mysql/certs/ca.pem
      - --ssl-cert=/etc/mysql/certs/server-cert.pem
      - --ssl-key=/etc/mysql/certs/server-key.pem
    volumes:
      - mysql-master-data:/var/lib/mysql
      - ./db/mysql/init.sql:/docker-entrypoint-initdb.d/init.sql:ro
      - ./db/certs:/etc/mysql/certs:ro
    ports:
      - "3307:3306"
    networks:
      - app-network
    restart: always
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${MYSQL_ROOT_PASSWORD}"]
      interval: 10s    
      timeout: 5s
      retries: 5
      start_period: 30s

  db-slave:
    build:
      context: ./db
    container_name: db-slave
    depends_on:
      db-master:
        condition: service_healthy
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-root}
      MYSQL_MASTER_HOST: db-master
      MYSQL_DATABASE: ${MYSQL_DATABASE:-appdb}
      MYSQL_USER: ${MYSQL_USER:-appuser}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD:-password}
    command:
      - --server-id=2
      - --relay-log=mysql-relay-bin
      - --log-slave-updates=ON
      - --read-only=ON
      - --gtid-mode=ON
      - --enforce-gtid-consistency=ON
      - --ssl-ca=/etc/mysql/certs/ca.pem
      - --ssl-cert=/etc/mysql/certs/client-cert.pem
      - --ssl-key=/etc/mysql/certs/client-key.pem
    volumes:
      - mysql-slave-data:/var/lib/mysql
      - ./db/certs:/etc/mysql/certs:ro
      - ./db/init-slave.sh:/docker-entrypoint-initdb.d/init-slave.sh:ro
    ports:
      - "3308:3306"
    networks:
      - app-network
    restart: always

  redis:
    image: redis:7-alpine    
    container_name: redis
    command: redis-server --appendonly yes
    volumes:
      - redis-data:/data
    ports:
      - "6379:6379"
    networks:
      - app-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5

  autenticacion:
    build:
      context: ./backend/autenticacion
    container_name: autenticacion
    environment:
      - FLASK_APP=app.py
      - FLASK_ENV=development 
      - DATABASE_URL=mysql+pymysql://${MYSQL_USER}:${MYSQL_PASSWORD}@db-master:3306/${MYSQL_DATABASE}
      - REDIS_URL=redis://redis:6379/0
      - JWT_SECRET_KEY=${JWT_SECRET_KEY}
    volumes:
      - ./backend/autenticacion/app:/app
      - ./backend/common:/app/common
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.auth.rule=PathPrefix(`/api/auth`)"
      - "traefik.http.middlewares.auth-strip.stripprefix.prefixes=/api/auth"
      - "traefik.http.routers.auth.middlewares=auth-strip"      
      - "traefik.http.services.auth.loadbalancer.server.port=8000"
    networks:
      - app-network
    restart: unless-stopped
    depends_on:
      db-master:
        condition: service_healthy
      redis:
        condition: service_started

  casos:
    build:
      context: ./backend/casos
    container_name: casos
    environment:
      - FLASK_APP=app.py
      - FLASK_ENV=development
      - DATABASE_URL=mysql+pymysql://${MYSQL_USER}:${MYSQL_PASSWORD}@db-master:3306/${MYSQL_DATABASE}
      - REDIS_URL=redis://redis:6379/1
    volumes:
      - ./backend/casos/app:/app
      - ./backend/common:/app/common
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.casos.rule=PathPrefix(`/api/casos`)"
      - "traefik.http.middlewares.casos-strip.stripprefix.prefixes=/api/casos"
      - "traefik.http.routers.casos.middlewares=casos-strip"
      - "traefik.http.services.casos.loadbalancer.server.port=5001"
    networks:
      - app-network
    restart: unless-stopped
    depends_on:
      db-master:
        condition: service_healthy

  documentos:
    build:
      context: ./backend/documentos
    container_name: documentos
    environment:
      - FLASK_APP=app.py
      - FLASK_ENV=development
      - DATABASE_URL=mysql+pymysql://${MYSQL_USER}:${MYSQL_PASSWORD}@db-master:3306/${MYSQL_DATABASE}
      - UPLOAD_FOLDER=/app/uploads
    volumes:
      - ./backend/documentos/app:/app
      - ./backend/common:/app/common
      - documentos-uploads:/app/uploads
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.docs.rule=PathPrefix(`/api/documentos`)"
      - "traefik.http.middlewares.docs-strip.stripprefix.prefixes=/api/documentos"
      - "traefik.http.routers.docs.middlewares=docs-strip"
      - "traefik.http.services.docs.loadbalancer.server.port=8002"
    networks:
      - app-network
    restart: unless-stopped
    depends_on:
      db-master:
        condition: service_healthy

  notificaciones:
    build:
      context: ./backend/notificaciones
    container_name: notificaciones
    environment:
      - FLASK_APP=app.py
      - FLASK_ENV=development
      - DATABASE_URL=mysql+pymysql://${MYSQL_USER}:${MYSQL_PASSWORD}@db-master:3306/${MYSQL_DATABASE}
      - REDIS_URL=redis://redis:6379/2
      - MAIL_SERVER=${SMTP_SERVER:-mailhog}
      - MAIL_PORT=${SMTP_PORT:-1025}
      - MAIL_USERNAME=${SMTP_USERNAME:-}
      - MAIL_PASSWORD=${SMTP_PASSWORD:-}
    volumes:
      - ./backend/notificaciones/app:/app
      - ./backend/common:/app/common
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.notif.rule=PathPrefix(`/api/notificaciones`)"
      - "traefik.http.middlewares.notif-strip.stripprefix.prefixes=/api/notificaciones"
      - "traefik.http.routers.notif.middlewares=notif-strip"
      - "traefik.http.services.notif.loadbalancer.server.port=8003"
    networks:
      - app-network
    restart: unless-stopped
    depends_on:
      db-master:
        condition: service_healthy

  frontend:
    build:
      context: ./frontend
    container_name: frontend
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.frontend.rule=Host(`localhost`)"
      - "traefik.http.services.frontend.loadbalancer.server.port=3000"
    volumes:
      - ./frontend:/app
      - frontend-node-modules:/app/node_modules
    environment:
      - CHOKIDAR_USEPOLLING=true
      - HOST=0.0.0.0
    stdin_open: true
    tty: true
    networks:
      - app-network
    restart: unless-stopped

  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    volumes:
      - ./monitoring/prometheus/prometheus_main.yml:/etc/prometheus/prometheus.yml
      - prometheus-data:/prometheus
    ports:
      - "9090:9090"
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
    networks:
      - app-network
    restart: unless-stopped

  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    environment:
      - GF_SECURITY_ADMIN_USER=${GRAFANA_USER:-admin}
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_PASSWORD:-admin}
    volumes:
      - grafana-data:/var/lib/grafana
    ports:
      - "3000:3000"
    networks:
      - app-network
    restart: unless-stopped
    depends_on:
      - prometheus

  mailhog:
    image: mailhog/mailhog
    container_name: mailhog
    ports:
      - "1025:1025"
      - "8025:8025"
    networks:
      - app-network

networks:
  app-network:
    driver: bridge

volumes:
  mysql-master-data:
  mysql-slave-data:
  redis-data:
  documentos-uploads:
  prometheus-data:
  grafana-data:
  frontend-node-modules: