services:
  # Config initializers using Alpine
  config-init-prometheus:
    image: alpine:latest
    container_name: config-init-prometheus
    env_file: .env
    environment:
      - SCRAPE_INTERVAL=${PROMETHEUS_SCRAPE_INTERVAL:-15s}
      - EVALUATION_INTERVAL=${PROMETHEUS_EVALUATION_INTERVAL:-15s}
    volumes:
      - ./scripts/config-templates/prometheus:/templates:ro
      - ./scripts/init-prometheus.sh:/init.sh:ro
      - prometheus-config:/config
    command: sh /init.sh

  config-init-traefik:
    image: alpine:latest
    container_name: config-init-traefik
    env_file: .env
    environment:
      - API_INSECURE=${TRAEFIK_API_INSECURE:-true}
      - DASHBOARD_ENABLED=${TRAEFIK_DASHBOARD_ENABLED:-true}
      - NETWORK_NAME=app-network
      - LOG_LEVEL=${TRAEFIK_LOG_LEVEL:-INFO}
    volumes:
      - ./scripts/config-templates/traefik:/templates:ro
      - ./scripts/init-traefik.sh:/init.sh:ro
      - traefik-config:/config
    command: sh /init.sh

  config-init-proxysql:
    image: alpine:latest
    container_name: config-init-proxysql
    env_file: .env
    environment:
      - PROXYSQL_ADMIN_USER=${PROXYSQL_ADMIN_USER:-admin}
      - PROXYSQL_ADMIN_PASSWORD=${PROXYSQL_ADMIN_PASSWORD:-admin}
      - MYSQL_MONITOR_USER=${MYSQL_MONITOR_USER}
      - MYSQL_MONITOR_PASSWORD=${MYSQL_MONITOR_PASSWORD}
      - MYSQL_DATABASE=${MYSQL_DATABASE}
      - MYSQL_MASTER_HOST=${MYSQL_MASTER_HOST:-db-master}
      - MYSQL_SLAVE_HOST=${MYSQL_SLAVE_HOST:-db-slave}
      - MYSQL_USER=${MYSQL_USER}
      - MYSQL_PASSWORD=${MYSQL_PASSWORD}
    volumes:
      - ./scripts/config-templates/proxysql:/templates:ro
      - ./scripts/init-proxysql.sh:/init.sh:ro
      - proxysql-config:/config
    command: sh /init.sh

  config-init-redis:
    image: alpine:latest
    container_name: config-init-redis
    env_file: .env
    environment:
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - REDIS_MAX_MEMORY=${REDIS_MAX_MEMORY:-256mb}
      - REDIS_DATABASES=${REDIS_DATABASES:-16}
    volumes:
      - ./scripts/config-templates/redis:/templates:ro
      - ./scripts/init-redis.sh:/init.sh:ro
      - redis-config:/config
    command: sh /init.sh

  #router
  gateway:
    image: traefik:v2.10  
    container_name: gateway    
    command:
      - "--api.insecure=true"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--entrypoints.web.address=:80"
      - "--serversTransport.forwardingTimeouts.dialTimeout=180s"
      - "--serversTransport.forwardingTimeouts.responseHeaderTimeout=180s"
      - "--serversTransport.forwardingTimeouts.idleConnTimeout=180s"
      - "--accesslog=true"
      - "--log.level=DEBUG"
    ports:
      - "8081:80"
      - "8080:8080"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - frontend-network
      - backend-network
    restart: unless-stopped
    depends_on:
      config-init-traefik:
        condition: service_completed_successfully

  db-init:
    image: alpine:latest
    container_name: db-init
    env_file: .env
    command: sh -c "
      apk add --no-cache sed &&
      echo 'Copying MASTER scripts...' &&
      cp /source-scripts-master/01-schema.sql /init-target-master/ &&
      cp /source-scripts-master/02-grants.sql.template /init-target-master/ &&
      cp /source-scripts-master/03-triggers.sql /init-target-master/ &&

      echo 'Copying SLAVE scripts...' &&
      cp /source-scripts-slave/init-slave.sh /init-target-slave/ &&
      cp /source-scripts-slave/01-create-replication-user.sql.template /init-target-slave/ &&

      echo 'Processing MASTER grants template...' &&
      sed -e 's|__MYSQL_DATABASE__|${MYSQL_DATABASE}|g' \
          -e 's|__MYSQL_MONITOR_PASSWORD__|${MYSQL_MONITOR_PASSWORD}|g' \
          -e 's|__MYSQL_MONITOR_USER__|${MYSQL_MONITOR_USER}|g' \
          -e 's|__MYSQL_REPLICATION_PASSWORD__|${MYSQL_REPLICATION_PASSWORD}|g' \
          -e 's|__MYSQL_PASSWORD__|${MYSQL_PASSWORD}|g' \
          -e 's|__MYSQL_PASSWORD_ADMIN_APP__|${MYSQL_PASSWORD_ADMIN_APP}|g' \
          -e 's|__MYSQL_PASSWORD_ABOGADO_APP__|${MYSQL_PASSWORD_ABOGADO_APP}|g' \
          -e 's|__MYSQL_PASSWORD_ASISTENTE_APP__|${MYSQL_PASSWORD_ASISTENTE_APP}|g' \
          -e 's|__MYSQL_PASSWORD_SISTEMAS_APP__|${MYSQL_PASSWORD_SISTEMAS_APP}|g' \
          -e 's|__MYSQL_PASSWORD_READONLY_APP__|${MYSQL_PASSWORD_READONLY_APP}|g' \
          /init-target-master/02-grants.sql.template > /init-target-master/02-grants.sql &&

      echo 'Processing SLAVE replication user template...' &&
      sed -e 's|__MYSQL_REPLICATION_PASSWORD__|${MYSQL_REPLICATION_PASSWORD}|g' \
          /init-target-slave/01-create-replication-user.sql.template > /init-target-slave/01-create-replication-user.sql &&

      echo 'Initialization scripts ready.'
      "
    volumes:
      - ./db/master/mysql:/source-scripts-master:ro
      - ./db/slave:/source-scripts-slave:ro
      - db-master-init-scripts:/init-target-master # Monta el volumen del master
      - db-slave-init-scripts:/init-target-slave

  db-master:
    build:
      context: ./db/master
    container_name: db-master
    env_file: .env
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-root}
      MYSQL_DATABASE: ${MYSQL_DATABASE:-causas_judiciales_db}
      MYSQL_USER: ${MYSQL_USER:-appuser}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD:-password}
    command:
      - --server-id=1
      - --log-bin=mysql-bin
      - --binlog-do-db=${MYSQL_DATABASE:-appdb}
      - --gtid-mode=ON
      - --enforce-gtid-consistency=ON
      - --ssl-ca=/etc/mysql/certs/ca.pem
      - --ssl-cert=/etc/mysql/certs/server-cert.pem
      - --ssl-key=/etc/mysql/certs/server-key.pem
    volumes:
      - mysql-master-data:/var/lib/mysql
      - db-master-init-scripts:/docker-entrypoint-initdb.d:ro # <- SOLO scripts del master
      - ./db/certs:/etc/mysql/certs:ro
    ports:
      - "3307:3306"
    networks:
      - database-network
    restart: always
    healthcheck:
      test: ["CMD-SHELL", "mysqladmin ping -h localhost -uroot -p$$MYSQL_ROOT_PASSWORD || exit 1"]
      interval: 10s    
      timeout: 5s
      retries: 5
      start_period: 30s
    depends_on:
      db-init:
        condition: service_completed_successfully

  db-proxy:
    build:
      context: ./db/proxy
    container_name: db-proxy
    env_file: .env
    volumes:
      - proxysql-config:/etc/proxysql:ro
      - proxysql-data:/var/lib/proxysql
    ports:
      - "6033:6033" # MySQL traffic
      - "6032:6032" # Admin interface
    networks:
      - backend-network
      - database-network
    restart: always
    depends_on:
      db-master:
        condition: service_healthy
      db-slave:
        condition: service_started
      config-init-proxysql:
        condition: service_completed_successfully

  db-slave:
    build:
      context: ./db/slave
    container_name: db-slave
    depends_on:
      db-master:
        condition: service_healthy
      db-init:
        condition: service_completed_successfully
    env_file: .env
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-root}
      MYSQL_MASTER_HOST: db-master
      MYSQL_DATABASE: ${MYSQL_DATABASE:-appdb}
      MYSQL_USER: ${MYSQL_USER:-appuser}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD:-password}
    command:
      - --server-id=2
      - --relay-log=mysql-relay-bin
      - --log-slave-updates=ON
      - --read-only=ON
      - --gtid-mode=ON
      - --enforce-gtid-consistency=ON
      - --ssl-ca=/etc/mysql/certs/ca.pem
      - --ssl-cert=/etc/mysql/certs/client-cert.pem
      - --ssl-key=/etc/mysql/certs/client-key.pem
    volumes:
      - mysql-slave-data:/var/lib/mysql
      - db-slave-init-scripts:/docker-entrypoint-initdb.d:ro # <- SOLO script del slave
      - ./db/certs:/etc/mysql/certs:ro
    ports:
      - "3308:3306"
    networks:
      - database-network
    restart: always

  redis:
    image: redis:7-alpine    
    container_name: redis
    command: redis-server /config/redis.conf
    volumes:
      - redis-data:/data
      - redis-config:/config:ro
    ports:
      - "6379:6379"
    networks:
      - cache-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD}", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5
    depends_on:
      config-init-redis:
        condition: service_completed_successfully

  redis-replica:
    image: redis:7-alpine
    container_name: redis-replica
    command: redis-server /config/redis.conf --replicaof redis 6379
    volumes:
      - redis-config:/config:ro
    depends_on:
      redis:
        condition: service_healthy
      config-init-redis:
        condition: service_completed_successfully
    ports:
      - "6380:6379"
    networks:
      - cache-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD}", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5

  autenticacion:
    build:
      context: ./backend/autenticacion
    container_name: autenticacion
    environment:
      - FLASK_APP=app.py
      - FLASK_ENV=development 
      - DATABASE_URL=mysql+pymysql://${MYSQL_USER}:${MYSQL_PASSWORD}@db-proxy:6033/${MYSQL_DATABASE}
      - REDIS_URL=redis://redis:6379/0
      - JWT_SECRET_KEY=${JWT_SECRET_KEY}
    volumes:
      - ./backend/autenticacion/app:/app
      - ./backend/common:/app/common
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=proyectolicitacion_admin2025_2_backend-network"
      - "traefik.http.routers.auth.rule=PathPrefix(`/api/auth`)"
      - "traefik.http.middlewares.auth-strip.stripprefix.prefixes=/api/auth"
      - "traefik.http.routers.auth.middlewares=auth-strip"      
      - "traefik.http.services.auth.loadbalancer.server.port=8000"
    networks:
      - backend-network
      - database-network
      - cache-network
    restart: unless-stopped
    depends_on:
      db-master:
        condition: service_started

  casos:
    build:
      context: ./backend/casos
    environment:
      - FLASK_APP=app.py
      - FLASK_ENV=development
      - DATABASE_URL=mysql+pymysql://${MYSQL_USER}:${MYSQL_PASSWORD}@db-proxy:6033/${MYSQL_DATABASE}
      - SECRET_KEY=${CASOS_SECRET_KEY}
      - REDIS_URL=redis://redis:6379/1
    volumes:
      - ./backend/casos/app:/app
      - ./backend/common:/app/common
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=proyectolicitacion_admin2025_2_backend-network"
      - "traefik.http.routers.casos.rule=PathPrefix(`/api/casos`)"
      - "traefik.http.middlewares.casos-strip.stripprefix.prefixes=/api/casos"
      - "traefik.http.routers.casos.middlewares=casos-strip"
      - "traefik.http.services.casos.loadbalancer.server.port=5001"
      - "traefik.http.services.casos.loadbalancer.responseForwarding.flushInterval=1ms"
      - "traefik.http.services.casos.loadbalancer.passhostheader=true"
    networks:
      - backend-network
      - database-network
      - cache-network
    restart: unless-stopped
    depends_on:
      db-master:
        condition: service_started
    deploy:
      replicas: 2

  documentos:
    build:
      context: ./backend/documentos
    container_name: documentos
    environment:
      - FLASK_APP=app.py
      - FLASK_ENV=development
      - DATABASE_URL=mysql+pymysql://${MYSQL_USER}:${MYSQL_PASSWORD}@db-proxy:6033/${MYSQL_DATABASE}
      - UPLOAD_FOLDER=/app/uploads
    volumes:
      - ./backend/documentos/app:/app
      - ./backend/common:/app/common
      - documentos-uploads:/app/uploads
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=proyectolicitacion_admin2025_2_backend-network"
      - "traefik.http.routers.docs.rule=PathPrefix(`/api/documentos`)"
      - "traefik.http.middlewares.docs-strip.stripprefix.prefixes=/api/documentos"
      - "traefik.http.routers.docs.middlewares=docs-strip"
      - "traefik.http.services.docs.loadbalancer.server.port=8002"
    networks:
      - backend-network
      - database-network
    restart: unless-stopped
    depends_on:
      db-master:
        condition: service_started

  notificaciones:
    build:
      context: ./backend/notificaciones
    container_name: notificaciones
    command: sh -c "gunicorn --bind 0.0.0.0:8003 --workers 2 --timeout 180 app:app & python worker.py"
    environment:
      - FLASK_APP=app.py
      - FLASK_ENV=development
      - DATABASE_URL=mysql+pymysql://${MYSQL_USER}:${MYSQL_PASSWORD}@db-proxy:6033/${MYSQL_DATABASE}
      - REDIS_URL=redis://redis:6379/2
      - MAIL_SERVER=${MAIL_SERVER:-mailhog}
      - MAIL_PORT=${MAIL_PORT:-1025}
      - MAIL_USERNAME=${MAIL_USERNAME:-}
      - MAIL_PASSWORD=${MAIL_PASSWORD:-}
    volumes:
      - ./backend/notificaciones/app:/app
      - ./backend/common:/app/common
    networks:
      - backend-network
      - database-network
      - cache-network
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=proyectolicitacion_admin2025_2_backend-network"
      - "traefik.http.routers.notificaciones.rule=PathPrefix(`/api/notificaciones`)"
      - "traefik.http.middlewares.notificaciones-strip.stripprefix.prefixes=/api/notificaciones"
      - "traefik.http.routers.notificaciones.middlewares=notificaciones-strip"
      - "traefik.http.services.notificaciones.loadbalancer.server.port=8003"
    depends_on:
      db-master:
        condition: service_started

  ia-seguridad:
    build:
      context: ./backend/ia-seguridad
    container_name: ia-seguridad
    env_file: .env
    environment:
      - FLASK_APP=app.py
      - FLASK_ENV=development
    volumes:
      - ./backend/ia-seguridad/app:/app
      - /var/run/docker.sock:/var/run/docker.sock:ro
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=proyectolicitacion_admin2025_2_backend-network"
      - "traefik.http.routers.ia-seguridad.rule=PathPrefix(`/api/ia-seguridad`)"
      - "traefik.http.routers.ia-seguridad.priority=100"
      - "traefik.http.middlewares.ia-seguridad-strip.stripprefix.prefixes=/api/ia-seguridad"
      - "traefik.http.routers.ia-seguridad.middlewares=ia-seguridad-strip"
      - "traefik.http.services.ia-seguridad.loadbalancer.server.port=8005"
    networks:
      - backend-network
      - monitoring-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8005/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  cron:
    build:
      context: ./cron
    container_name: cron
    networks:
      - backend-network
    depends_on:
      - notificaciones
    restart: unless-stopped

  reportes:
    build:
      context: ./backend/reportes
    container_name: reportes
    environment:
      - FLASK_APP=app.py
      - FLASK_ENV=development
      - DATABASE_URL=mysql+pymysql://${MYSQL_USER}:${MYSQL_PASSWORD}@db-proxy:6033/${MYSQL_DATABASE}
    volumes:
      - ./backend/reportes/app:/app
      - ./backend/common:/app/common
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=proyectolicitacion_admin2025_2_backend-network"
      - "traefik.http.routers.reportes.rule=PathPrefix(`/api/reportes`)"
      - "traefik.http.middlewares.reportes-strip.stripprefix.prefixes=/api/reportes"
      - "traefik.http.routers.reportes.middlewares=reportes-strip"
      - "traefik.http.services.reportes.loadbalancer.server.port=8004"
    networks:
      - backend-network
      - database-network

  frontend:
    build:
      context: ./frontend
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=proyectolicitacion_admin2025_2_frontend-network"
      - "traefik.http.routers.frontend.rule=Host(`localhost`)"
      - "traefik.http.services.frontend.loadbalancer.server.port=3000"
    volumes:
      - ./frontend:/app
      - frontend-node-modules:/app/node_modules
    environment:
      - CHOKIDAR_USEPOLLING=true
      - HOST=0.0.0.0
    stdin_open: true
    tty: true
    depends_on:
      - reportes
    networks:
      - frontend-network
      - backend-network
    restart: unless-stopped

    deploy:
      replicas: 2

  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    volumes:
      - prometheus-config:/etc/prometheus:ro
      - prometheus-data:/prometheus
    ports:
      - "9090:9090"
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
    networks:
      - monitoring-network
    restart: unless-stopped
    depends_on:
      config-init-prometheus:
        condition: service_completed_successfully

  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    environment:
      - GF_SECURITY_ADMIN_USER=${GRAFANA_USER:-admin}
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_PASSWORD:-admin}
    volumes:
      - grafana-data:/var/lib/grafana
    ports:
      - "3000:3000"
    networks:
      - monitoring-network
    restart: unless-stopped
    depends_on:
      - prometheus

  mailhog:
    image: mailhog/mailhog
    container_name: mailhog
    ports:
      - "1025:1025"
      - "8025:8025"
    networks:
      - backend-network

  backup-service:
    build:
      context: ./backup-service
    container_name: backup-service
    environment:
      - MYSQL_HOST=db-master
      - MYSQL_USER=root
      - MYSQL_PASSWORD=${MYSQL_ROOT_PASSWORD:-root_password_2025}
      - MYSQL_DATABASE=${MYSQL_DATABASE:-causas_judiciales_db}
      - BACKUP_RETENTION_DAYS=7
    volumes:
      - ./backups:/backups
      - documentos-uploads:/data/documentos:ro
    networks:
      - database-network
      - monitoring-network
    depends_on:
      - db-master
    restart: unless-stopped

  # Auto-Failover Daemon
  failover-daemon:
    build:
      context: .
      dockerfile: monitoring/failover/Dockerfile
    container_name: failover-daemon
    env_file: .env
    command: /scripts/auto-failover-daemon.sh
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./.env:/config/.env:ro
    networks:
      - database-network
      - monitoring-network
    depends_on:
      db-master:
        condition: service_started
      db-slave:
        condition: service_started
      db-proxy:
        condition: service_started
    restart: unless-stopped

  # Auto-Failback Daemon (opcional)
  failback-daemon:
    build:
      context: .
      dockerfile: monitoring/failover/Dockerfile
    container_name: failback-daemon
    env_file: .env
    command: /scripts/auto-failback-daemon.sh
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./.env:/config/.env:ro
    networks:
      - database-network
      - monitoring-network
    depends_on:
      db-master:
        condition: service_started
      db-slave:
        condition: service_started
      db-proxy:
        condition: service_started
    restart: unless-stopped
    profiles:
      - failback  # Solo se inicia con: docker-compose --profile failback up

networks:
  frontend-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/24
  
  backend-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.21.0.0/24
  
  database-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.22.0.0/24
  
  cache-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.23.0.0/24
  
  monitoring-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.24.0.0/24

volumes:
  mysql-master-data:
  mysql-slave-data:
  redis-data:
  documentos-uploads:
  prometheus-data:
  prometheus-config:
  grafana-data:
  frontend-node-modules:
  db-master-init-scripts: {}
  db-slave-init-scripts: {}
  redis-config:
  proxysql-config:
  proxysql-data:
  traefik-config:
